#!/usr/bin/env python

import os


__dirname__ = os.path.abspath(os.path.dirname(__file__))


def print_section_title(title):
    l = "    ------------------------------------------------"
    align_spaces = ((len(l) - 4 - len(title)) >> 1)
    align_spaces = max([align_spaces, 0]) * " "
    print(l)
    print("    " + align_spaces + title)
    print(l)


def activate_and_do(*cmds):
    # TODO(platforms): use platform specific activation and "&&"
    activate = "source ./venv/bin/activate"
    return os.system(f"{activate} && {' && '.join(cmds)}")


def create_venv():
    print_section_title("📦 إنشاء بيئة افتراضية لتشغيل أكواد بايثون ...")
    os.chdir(__dirname__)

    if not os.path.exists("./متطلبات"):
        print("لا يوجد ملف المتطلبات\n", file=os.sys.stderr)
        exit(1)

    ec = os.system("python -m venv venv")  # TODO(platforms)
    if not ec:
        ec = activate_and_do("python -m pip install -r ./متطلبات")
        if ec:
            print("حدث خطأ عند محاولة تنصيب الحزم من ملف ./متطلبات\n", file=os.sys.stderr)
            exit(ec)
    else:
        print("حدث خطأ عند محاولة إنشاء بيئة افتراضية لبايثون\n", file=os.sys.stderr)
        exit(ec)


def build_alif():
    print_section_title("🚀 جاري بناء مترجم ألف ...")
    # TODO(platforms): check privileges
    if os.environ.get("USER") != "root":
        print("يجب تشغيل هذا الأمر بصلاحيات المستخدم الجذر، استخدم `sudo`\n", file=os.sys.stderr)
        exit(1)
    build_dir = os.path.join(__dirname__, "../build")
    if not os.path.exists(build_dir):
        os.system(f'mkdir -p "{build_dir}"')
    os.chdir(build_dir)
    # TODO(platforms): different build commands in different platforms platforms
    os.system("cmake .. && make && sudo make install")


if __name__ == "__main__":
    os.chdir(__dirname__)
    if not os.path.exists("./venv"):
        create_venv()
    args = os.sys.argv[1:]
    if os.sys.argv[1:].count("--ابن-ألف") > 0:
        build_alif()
        args = filter(lambda a: a != "--ابن-ألف", args)
    args = map(lambda a: f"'{a}'", args)
    print_section_title("🔍 إجراء الاختبارات ...")
    os.chdir(__dirname__)
    activate_and_do(f"python ./اجراء_الاختبارات {' '.join(args)}")
